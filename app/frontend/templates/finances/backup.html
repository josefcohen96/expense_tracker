{% extends "layout/base.html" %}
{% block title %}גיבוי{% endblock %}

{% block content %}
<div class="w-full animate-sequence">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6">
            <div class="animate-sequence">
                <h1 class="text-4xl font-bold text-gradient mb-2">ניהול גיבויים</h1>
                <p class="text-gray-600 text-lg">צרו ושמרו גיבויים של הנתונים הפיננסיים שלכם</p>
            </div>
        </div>
    </div>

    <!-- Create Backup Section -->
    <div class="card animate-sequence mb-8">
        <div class="card-header">
            <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                <i class="fas fa-download mr-3 text-blue-600"></i>
                צור גיבוי חדש
            </h2>
        </div>
        <div class="card-body">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Full backup -->
                <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-all duration-300">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-primary rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-database text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">גיבוי מלא</h3>
                            <p class="text-sm text-gray-600">6 החודשים האחרונים</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">צור גיבוי Excel מלא של 6 החודשים האחרונים עם כל העסקאות וההוצאות הקבועות</p>
                    <form method="post" action="/backup/create">
                        <button type="submit" class="btn btn-primary w-full">
                            <i class="fas fa-download mr-2"></i>
                            צור גיבוי מלא
                        </button>
                    </form>
                </div>
                
                <!-- Monthly backup -->
                <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-all duration-300">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-gradient-success rounded-full flex items-center justify-center mr-4">
                            <i class="fas fa-calendar-alt text-white text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">גיבוי חודשי</h3>
                            <p class="text-sm text-gray-600">חודש ספציפי</p>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">צור גיבוי Excel של חודש ספציפי עם כל העסקאות של אותו חודש</p>
                    <form id="monthlyBackupForm" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div class="form-group">
                                <label class="form-label">שנה</label>
                                <select id="yearSelect" class="form-select">
                                    {% for year in range(2024, 2026) %}
                                    <option value="{{ year }}" {% if year == 2024 %}selected{% endif %}>{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">חודש</label>
                                <select id="monthSelect" class="form-select">
                                    {% for month in range(1, 13) %}
                                    <option value="{{ month }}" {% if month == 8 %}selected{% endif %}>{{ month }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success w-full">
                            <i class="fas fa-calendar-plus mr-2"></i>
                            צור גיבוי חודשי
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    
<script>
document.getElementById('monthlyBackupForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const year = document.getElementById('yearSelect').value;
    const month = document.getElementById('monthSelect').value;
    const button = this.querySelector('button[type="submit"]');
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>יוצר גיבוי...';
        button.disabled = true;
        
        const response = await fetch(`/api/backup/monthly/${year}/${month}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            showToast(`הגיבוי נוצר בהצלחה! קובץ: ${result.file}`, 'success');
            
            // Refresh the page to show the new backup
            setTimeout(() => {
                location.reload();
            }, 1500);
        } else {
            const error = await response.json();
            showToast(`שגיאה ביצירת הגיבוי: ${error.detail}`, 'error');
        }
    } catch (error) {
        showToast(`שגיאה ביצירת הגיבוי: ${error.message}`, 'error');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
});

</script>
{% endblock %}
