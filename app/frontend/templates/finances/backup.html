{% extends "layout/base.html" %}

{% block title %}גיבוי - פיננסים{% endblock %}

{% block content %}
<div class="space-y-6">
  <h1 class="text-2xl font-bold">גיבוי</h1>

  <div class="bg-white p-4 rounded shadow">
    <button id="createBackup" class="btn btn-primary">צור גיבוי עכשיו</button>
  </div>

  <div class="bg-white p-4 rounded shadow">
    <h2 class="text-xl font-semibold mb-4">קבצי גיבוי</h2>
    <ul id="backupList" class="list-disc pr-6"></ul>
  </div>
</div>

<script>
function formatSize(bytes){
  const b = Number(bytes || 0);
  if (!isFinite(b) || b <= 0) return '0 B';
  const units = ['B','KB','MB','GB','TB'];
  const i = Math.min(units.length - 1, Math.floor(Math.log(b) / Math.log(1024)));
  const val = b / Math.pow(1024, i);
  return `${val.toFixed(val >= 10 ? 0 : 1)} ${units[i]}`;
}

async function refreshBackups() {
  try {
    const res = await fetch('/api/backup');
    if (!res.ok) return;
    const data = await res.json();
    const list = document.getElementById('backupList');
    list.innerHTML = '';
    (data.backups || []).forEach(item => {
      const name = item && typeof item === 'object' ? (item.file || '') : String(item || '');
      const sizeStr = item && typeof item === 'object' ? formatSize(item.size) : '';
      const createdStr = item && typeof item === 'object' && item.created ? new Date(item.created).toLocaleString('he-IL') : '';
      const canDownload = /\.(zip|xlsx|xlsm)$/i.test(name);
      const li = document.createElement('li');
      li.className = 'mb-2';
      li.innerHTML = `
        <span class="mr-2 font-medium">${name}</span>
        <span class="text-gray-500 mr-2">${sizeStr}${createdStr ? ' · ' + createdStr : ''}</span>
        ${canDownload ? `<a class="text-blue-600 hover:underline mr-2" href="/api/backup/download/${name}">הורדה</a>` : ''}
        <button class="text-red-600 hover:underline" onclick="deleteBackup('${name}')">מחיקה</button>
      `;
      list.appendChild(li);
    });
  } catch (e) { console.error(e); }
}

async function deleteBackup(name) {
  if (!confirm('למחוק את הקובץ?')) return;
  const res = await fetch(`/api/backup/${name}`, { method: 'DELETE' });
  if (res.ok) refreshBackups();
}

document.getElementById('createBackup').addEventListener('click', async () => {
  const btn = document.getElementById('createBackup');
  const orig = btn.textContent;
  btn.textContent = 'יוצר...';
  btn.disabled = true;
  try {
    const res = await fetch('/api/backup/create', { method: 'POST' });
    if (res.ok) {
      await refreshBackups();
      btn.textContent = 'נוצר!';
      setTimeout(()=> btn.textContent = orig, 1000);
    } else {
      btn.textContent = 'שגיאה';
      setTimeout(()=> btn.textContent = orig, 1500);
    }
  } catch (e) { console.error(e); btn.textContent = orig; }
  finally { btn.disabled = false; }
});

document.addEventListener('DOMContentLoaded', refreshBackups);
</script>
{% endblock %}


