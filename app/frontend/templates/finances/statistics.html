{% extends "layout/base.html" %}

{% block title %}סטטיסטיקות - פיננסים{% endblock %}

{% block content %}
<div class="space-y-6">
  <h1 class="text-2xl font-bold">סטטיסטיקות</h1>

  <!-- Global month filter -->
  <div class="card mb-6">
    <div class="card-body">
      <form method="get" class="flex items-center gap-4">
        <div class="flex items-center gap-2">
          <i class="fas fa-calendar text-primary-600"></i>
          <label for="month" class="text-sm font-medium text-gray-700">בחר חודש</label>
        </div>
        <input id="month" name="month" type="month" value="{{ selected_month or '' }}" class="form-input">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-sync-alt mr-2"></i>
          עדכן
        </button>
      </form>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <!-- Expenses Card -->
    <a href="/finances/statistics/drilldown?metric=expenses&month={{ selectedmonth }}"
      class="card card-elevated hover:scale-105 transition-all block">
      <div class="p-5">
        <div class="flex items-center justify-between mb-3">
          <span class="text-sm font-medium text-gray-600">הוצאות החודש</span>
          <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center">
            <i class="fas fa-arrow-down text-red-600"></i>
          </div>
        </div>
        <div class="font-mono text-3xl font-bold text-red-600" dir="ltr">
          ₪{{ total_expenses_month }}
        </div>
      </div>
    </a>

    <!-- Income Card -->
    <a href="/finances/statistics/drilldown?metric=income&month={{ selected_month }}"
      class="card card-elevated hover:scale-105 transition-all block">
      <div class="p-5">
        <div class="flex items-center justify-between mb-3">
          <span class="text-sm font-medium text-gray-600">הכנסות החודש</span>
          <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
            <i class="fas fa-arrow-up text-green-600"></i>
          </div>
        </div>
        <div class="font-mono text-3xl font-bold text-green-600" dir="ltr">
          ₪{{ total_income_month }}
        </div>
      </div>
    </a>

    <!-- Transactions Card -->
    <a href="/finances/statistics/drilldown?metric=transactions&month={{ selected_month }}"
      class="card card-elevated hover:scale-105 transition-all block">
      <div class="p-5">
        <div class="flex items-center justify-between mb-3">
          <span class="text-sm font-medium text-gray-600">עסקאות החודש</span>
          <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
            <i class="fas fa-exchange-alt text-blue-600"></i>
          </div>
        </div>
        <div class="font-mono text-3xl font-bold text-gray-900">
          {{ total_transactions_month }}
        </div>
      </div>
    </a>

    <!-- Recurring Card -->
    <a href="/finances/statistics/drilldown?metric=recurring&month={{ selected_month }}"
      class="card card-elevated hover:scale-105 transition-all block">
      <div class="p-5">
        <div class="flex items-center justify-between mb-3">
          <span class="text-sm font-medium text-gray-600">הוצאות קבועות</span>
          <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
            <i class="fas fa-repeat text-purple-600"></i>
          </div>
        </div>
        <div class="font-mono text-3xl font-bold text-gray-900">
          {{ total_recurring_month }}
        </div>
      </div>
    </a>
  </div>

  <!-- Main 2x2 layout -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
    <!-- Left column: tables -->
    <div class="space-y-6">
      <!-- Top 5 regular expenses -->
      <div class="card">
        <div class="card-header">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <i class="fas fa-chart-bar text-red-600 mr-2"></i>
            5 ההוצאות הרגילות הגדולות ביותר
            <span class="text-sm font-normal text-gray-500 mr-2">(6 חודשים)</span>
          </h2>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-center text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th
                  class="px-4 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">
                  תאריך</th>
                <th
                  class="px-4 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">
                  סכום (₪)</th>
                <th
                  class="px-4 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">
                  הערות</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for r in top_regular_expenses %}
              <tr class="hover:bg-red-50 transition-colors">
                <td class="px-4 py-3 whitespace-nowrap text-gray-900">{{ r.date }}</td>
                <td class="px-4 py-3 whitespace-nowrap font-mono text-red-600 font-bold" dir="ltr">₪{{ (r.amount or 0) |
                  round(2) }}</td>
                <td class="px-4 py-3 text-gray-600">{{ r.notes }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                  <i class="fas fa-inbox text-3xl text-gray-300 mb-2"></i>
                  <div>אין נתונים להצגה</div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Cash vs Credit per user -->
      <div class="card">
        <div class="card-header">
          <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <i class="fas fa-users text-blue-600 mr-2"></i>
            הוצאות מזומן ואשראי לפי משתמש
            <span class="text-sm font-normal text-gray-500 mr-2">(6 חודשים)</span>
          </h2>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-center text-sm">
            <thead class="bg-gray-100">
              <tr>
                <th
                  class="px-4 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">
                  משתמש</th>
                <th
                  class="px-4 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">
                  מזומן</th>
                <th
                  class="px-4 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">
                  אשראי</th>
                <th
                  class="px-4 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">
                  אחר</th>
                <th
                  class="px-4 py-3 text-xs font-semibold text-gray-700 uppercase tracking-wider border-b-2 border-gray-200">
                  סה"כ</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              {% for row in cash_credit_user_totals %}
              <tr class="hover:bg-blue-50 transition-colors">
                <td class="px-4 py-3 whitespace-nowrap font-medium text-gray-900">
                  <i class="fas fa-user text-gray-400 ml-2"></i>
                  {{ row.user }}
                </td>
                <td class="px-4 py-3 whitespace-nowrap font-mono text-gray-700" dir="ltr">₪{{ row.cash | round(2) }}
                </td>
                <td class="px-4 py-3 whitespace-nowrap font-mono text-gray-700" dir="ltr">₪{{ row.credit | round(2) }}
                </td>
                <td class="px-4 py-3 whitespace-nowrap font-mono text-gray-700" dir="ltr">₪{{ row.other | round(2) }}
                </td>
                <td class="px-4 py-3 whitespace-nowrap font-mono font-bold text-gray-900" dir="ltr">₪{{ row.total |
                  round(2) }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                  <i class="fas fa-inbox text-3xl text-gray-300 mb-2"></i>
                  <div>אין נתונים להצגה</div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Right column: charts (monthly + donut) -->
    <div>
      {% include 'partials/stats/charts.html' ignore missing %}
    </div>
  </div>

</div>
{% include 'partials/stats/modal.html' %}
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js -->
<script src="/static/js/vendor/chart.umd.min.js"></script>

<!-- Inline JSON data for charts -->
<script id="monthly-data" type="application/json">{{ monthly_data | tojson }}</script>
<script id="category-data" type="application/json">{{ category_data | tojson }}</script>
{# removed recurrences inline data (unused) #}

<!-- Charts scripts -->
<script type="module" src="/static/js/charts/monthly.js"></script>
<script type="module" src="/static/js/charts/donut.js"></script>
{# removed recurrences chart script (canvas removed) #}
{% endblock %}