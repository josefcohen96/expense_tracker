{% extends "layout/base.html" %}

{% block title %}סטטיסטיקות - פיננסים{% endblock %}

{% block content %}
<div class="space-y-6">
  <h1 class="text-2xl font-bold">סטטיסטיקות</h1>

  <!-- Global month filter -->
  <form method="get" class="flex items-center gap-3 bg-white p-4 rounded shadow w-full max-w-sm">
    <label for="month" class="text-sm text-gray-600">בחר חודש</label>
    <input id="month" name="month" type="month" value="{{ selected_month or '' }}" class="border rounded px-2 py-1">
    <button type="submit" class="bg-indigo-600 text-white px-3 py-1 rounded">עדכן</button>
  </form>

  <!-- KPIs -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <a href="/finances/statistics/drilldown?metric=expenses&month={{ selected_month }}" class="bg-white p-4 rounded shadow block hover:shadow-md transition">
      <div class="text-gray-500">הוצאות החודש</div>
      <div class="text-2xl font-bold text-red-600">₪{{ total_expenses_month }}</div>
    </a>
    <a href="/finances/statistics/drilldown?metric=income&month={{ selected_month }}" class="bg-white p-4 rounded shadow block hover:shadow-md transition">
      <div class="text-gray-500">הכנסות החודש</div>
      <div class="text-2xl font-bold text-green-600">₪{{ total_income_month }}</div>
    </a>
    <a href="/finances/statistics/drilldown?metric=transactions&month={{ selected_month }}" class="bg-white p-4 rounded shadow block hover:shadow-md transition">
      <div class="text-gray-500">עסקאות החודש</div>
      <div class="text-2xl font-bold">{{ total_transactions_month }}</div>
    </a>
    <a href="/finances/statistics/drilldown?metric=recurring&month={{ selected_month }}" class="bg-white p-4 rounded shadow block hover:shadow-md transition">
      <div class="text-gray-500">הוצאות קבועות החודש</div>
      <div class="text-2xl font-bold">{{ total_recurring_month }}</div>
    </a>
  </div>

  <!-- Main 2x2 layout -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-start">
    <!-- Left column: tables -->
    <div class="space-y-6">
      <!-- Top 5 regular expenses -->
      <div class="bg-white rounded shadow">
        <div class="px-4 pt-4">
          <h2 class="text-lg font-semibold">5 ההוצאות הרגילות הגדולות ביותר (6 חודשים)</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-center text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 border-b">תאריך</th>
                <th class="px-3 py-2 border-b">סכום (₪)</th>
                <th class="px-3 py-2 border-b">הערות</th>
              </tr>
            </thead>
            <tbody>
              {% for r in top_regular_expenses %}
              <tr class="hover:bg-gray-50">
                <td class="px-3 py-2 border-b">{{ r.date }}</td>
                <td class="px-3 py-2 border-b text-red-600 font-semibold">{{ (r.amount or 0) | round(2) }}</td>
                <td class="px-3 py-2 border-b">{{ r.notes }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="6" class="px-4 py-6 text-gray-500">אין נתונים להצגה</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Cash vs Credit per user -->
      <div class="bg-white rounded shadow">
        <div class="px-4 pt-4">
          <h2 class="text-lg font-semibold">הוצאות מזומן ואשראי לפי משתמש (6 חודשים)</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-center text-sm">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 border-b">משתמש</th>
                <th class="px-3 py-2 border-b">מזומן</th>
                <th class="px-3 py-2 border-b">אשראי</th>
                <th class="px-3 py-2 border-b">אחר</th>
                <th class="px-3 py-2 border-b">סה"כ</th>
              </tr>
            </thead>
            <tbody>
              {% for row in cash_credit_user_totals %}
              <tr class="hover:bg-gray-50">
                <td class="px-3 py-2 border-b">{{ row.user }}</td>
                <td class="px-3 py-2 border-b">{{ row.cash | round(2) }}</td>
                <td class="px-3 py-2 border-b">{{ row.credit | round(2) }}</td>
                <td class="px-3 py-2 border-b">{{ row.other | round(2) }}</td>
                <td class="px-3 py-2 border-b font-semibold">{{ row.total | round(2) }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="5" class="px-4 py-6 text-gray-500">אין נתונים להצגה</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Right column: charts (monthly + donut) -->
    <div>
      {% include 'partials/stats/charts.html' ignore missing %}
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
  <!-- Chart.js -->
  <script src="/static/js/vendor/chart.umd.min.js"></script>

  <!-- Inline JSON data for charts -->
  <script id="monthly-data" type="application/json">{{ monthly_data | tojson }}</script>
  <script id="category-data" type="application/json">{{ category_data | tojson }}</script>
  {# removed recurrences inline data (unused) #}

  <!-- Charts scripts -->
  <script type="module" src="/static/js/charts/monthly.js"></script>
  <script type="module" src="/static/js/charts/donut.js"></script>
  {# removed recurrences chart script (canvas removed) #}
{% endblock %}
