{% extends "layout/base.html" %}
{% block title %}סטטיסטיקות{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-6">סטטיסטיקות</h1>

<!-- נתונים חשובים לחודש הנוכחי -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
  <!-- כמות עסקאות -->
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex items-center">
      <div class="p-2 rounded-full bg-blue-100 text-blue-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
        </svg>
      </div>
      <div class="mr-3">
        <p class="text-sm font-medium text-gray-600">כמות עסקאות</p>
        <p class="text-2xl font-bold text-gray-900">{{ total_transactions_month|default(0) }}</p>
        <p class="text-sm text-gray-500">{{ total_regular_month|default(0) }} רגילות + {{ total_recurring_month|default(0) }} קבועות</p>
      </div>
    </div>
  </div>

  <!-- מספר הוצאות קבועות -->
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex items-center">
      <div class="p-2 rounded-full bg-green-100 text-green-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
        </svg>
      </div>
      <div class="mr-3">
        <p class="text-sm font-medium text-gray-600">הוצאות קבועות</p>
        <p class="text-2xl font-bold text-gray-900">{{ total_recurring_month|default(0) }}</p>
        <p class="text-sm text-gray-500">מתוך {{ total_transactions_month|default(0) }} עסקאות</p>
      </div>
    </div>
  </div>

  <!-- סכום הוצאות סה"כ -->
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex items-center">
      <div class="p-2 rounded-full bg-red-100 text-red-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
        </svg>
      </div>
      <div class="mr-3">
        <p class="text-sm font-medium text-gray-600">סכום הוצאות</p>
        <p class="text-2xl font-bold text-red-600">{{ "%.2f"|format(total_expenses_month|default(0)) }} ₪</p>
        {% if expenses_change != 0 %}
        <p class="text-sm {% if expenses_change > 0 %}text-red-600{% else %}text-green-600{% endif %}">
          {% if expenses_change > 0 %}↗{% else %}↘{% endif %} {{ "%.1f"|format(expenses_change|abs) }}%
        </p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- סכום הכנסות סה"כ -->
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex items-center">
      <div class="p-2 rounded-full bg-green-100 text-green-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
        </svg>
      </div>
      <div class="mr-3">
        <p class="text-sm font-medium text-gray-600">סכום הכנסות</p>
        <p class="text-2xl font-bold text-green-600">{{ "%.2f"|format(total_income_month|default(0)) }} ₪</p>
        {% if income_change != 0 %}
        <p class="text-sm {% if income_change > 0 %}text-green-600{% else %}text-red-600{% endif %}">
          {% if income_change > 0 %}↗{% else %}↘{% endif %} {{ "%.1f"|format(income_change|abs) }}%
        </p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- כמות קטגוריות פעילות -->
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex items-center">
      <div class="p-2 rounded-full bg-purple-100 text-purple-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
        </svg>
      </div>
      <div class="mr-3">
        <p class="text-sm font-medium text-gray-600">קטגוריות פעילות</p>
        <p class="text-2xl font-bold text-gray-900">{{ categories_count|default(0) }}</p>
      </div>
    </div>
  </div>

  <!-- הוצאות 6 חודשים אחרונים -->
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex items-center">
      <div class="p-2 rounded-full bg-orange-100 text-orange-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg>
      </div>
      <div class="mr-3">
        <p class="text-sm font-medium text-gray-600">הוצאות 6 חודשים</p>
        <p class="text-2xl font-bold text-orange-600">{{ "%.2f"|format(total_expenses_6months|default(0)) }} ₪</p>
      </div>
    </div>
  </div>
</div>

<!-- שינויים מהחודש הקודם -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <!-- שינוי בהוצאות -->
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">שינוי בהוצאות</p>
        <p class="text-lg font-bold {% if expenses_change > 0 %}text-red-600{% else %}text-green-600{% endif %}">
          {% if expenses_change > 0 %}↗{% else %}↘{% endif %} {{ "%.1f"|format(expenses_change|abs) }}%
        </p>
      </div>
      <div class="p-2 rounded-full {% if expenses_change > 0 %}bg-red-100 text-red-600{% else %}bg-green-100 text-green-600{% endif %}">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
        </svg>
      </div>
    </div>
  </div>

  <!-- שינוי בהכנסות -->
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">שינוי בהכנסות</p>
        <p class="text-lg font-bold {% if income_change > 0 %}text-green-600{% else %}text-red-600{% endif %}">
          {% if income_change > 0 %}↗{% else %}↘{% endif %} {{ "%.1f"|format(income_change|abs) }}%
        </p>
      </div>
      <div class="p-2 rounded-full {% if income_change > 0 %}bg-green-100 text-green-600{% else %}bg-red-100 text-red-600{% endif %}">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
        </svg>
      </div>
    </div>
  </div>

  <!-- יתרה -->
  <div class="bg-white rounded-lg shadow p-4">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-gray-600">יתרה</p>
        <p class="text-lg font-bold {% if balance_month > 0 %}text-green-600{% else %}text-red-600{% endif %}">
          {{ "%.2f"|format(balance_month|default(0)) }} ₪
        </p>
        {% if balance_change != 0 %}
        <p class="text-sm {% if balance_change > 0 %}text-green-600{% else %}text-red-600{% endif %}">
          {% if balance_change > 0 %}↗{% else %}↘{% endif %} {{ "%.1f"|format(balance_change|abs) }}%
        </p>
        {% endif %}
      </div>
      <div class="p-2 rounded-full {% if balance_month > 0 %}bg-green-100 text-green-600{% else %}bg-red-100 text-red-600{% endif %}">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path>
        </svg>
      </div>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
  <!-- חודשי -->
  <section class="bg-white rounded-2xl shadow p-5 xl:col-span-2">
    <header class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">הוצאות 6 חודשים אחרונים</h2>
      <!-- קטגוריה סינון -->
      <div>
        <label for="monthly-category" class="mr-2">קטגוריה:</label>
        <select id="monthly-category" class="border rounded px-2 py-1">
          <option value="total">סה"כ</option>
          {% for cat in category_expenses %}
            <option value="{{ cat.category }}">{{ cat.category }}</option>
          {% endfor %}
        </select>
      </div>
    </header>
    <!-- שמים קונטיינר עם גובה קבוע וה-canvas מתרחב בתוכו -->
    <div class="relative h-72 md:h-80 xl:h-96">
      <canvas id="monthly-chart" class="absolute inset-0"></canvas>
    </div>
  </section>

  <!-- 5 ההוצאות הכי גדולות -->
  <section class="bg-white rounded-2xl shadow p-5">
    <header class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">5 ההוצאות הכי גדולות (3 חודשים אחרונים)</h2>
    </header>
    <div class="space-y-3">
      {% for expense in top_expenses %}
      <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
        <div class="flex-1">
          <div class="flex items-center gap-2">
            <span class="font-medium text-gray-900">{{ expense.notes or "ללא הערות" }}</span>
            <span class="text-sm text-gray-500">({{ expense.category }})</span>
          </div>
          <div class="text-sm text-gray-600">
            {{ expense.date }} • {{ expense.user_name }}
            {% if expense.account_name %}
            • {{ expense.account_name }}
            {% endif %}
          </div>
        </div>
        <div class="text-right">
          <div class="text-lg font-bold text-red-600">
            {{ "%.2f"|format(expense.amount|abs) }} ₪
          </div>
        </div>
      </div>
      {% else %}
      <div class="text-center text-gray-500 py-8">
        אין הוצאות ב-3 חודשים האחרונים
      </div>
      {% endfor %}
    </div>
  </section>

  <!-- לפי קטגוריה -->
  <section class="bg-white rounded-2xl shadow p-5 xl:col-span-2">
    <header class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">חלוקה לפי קטגוריה</h2>
      <!-- Month selector -->
      <div class="flex items-center gap-2">
        <label for="donut-month-single">בחר חודש:</label>
        <input id="donut-month-single" type="month" class="border rounded px-2 py-1" />
      </div>
    </header>
    <div class="relative h-72 md:h-80 xl:h-96">
      <canvas id="donut-chart" class="absolute inset-0"></canvas>
    </div>
  </section>

  <!-- הוצאות קבועות -->
  <section class="bg-white rounded-2xl shadow p-5">
    <header class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">הוצאות קבועות 6 חודשים אחרונים</h2>
    </header>
    <div class="relative h-72 md:h-80 xl:h-96">
      <canvas id="recurrences-chart" class="absolute inset-0"></canvas>
    </div>
  </section>
  
  <!-- מזומן מול אשראי -->
  <section class="bg-white rounded-2xl shadow p-5 xl:col-span-3">
    <header class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">מזומן מול אשראי - 6 חודשים אחרונים</h2>
    </header>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left text-gray-500">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3">חודש</th>
            <th scope="col" class="px-6 py-3">משתמש</th>
            <th scope="col" class="px-6 py-3">מזומן</th>
            <th scope="col" class="px-6 py-3">כרטיס אשראי</th>
            <th scope="col" class="px-6 py-3">סה"כ</th>
            <th scope="col" class="px-6 py-3">אחוז מזומן</th>
          </tr>
        </thead>
        <tbody>
          {% for item in cash_vs_credit %}
            {% set total = 0 %}
            {% set cash_amount = 0 %}
            {% set credit_amount = 0 %}
            
            {% if item.account_type == 'Combined' %}
              {% set total = item.total %}
              {% set cash_amount = item.cash_amount %}
              {% set credit_amount = item.credit_amount %}
            {% elif item.account_type == 'User' %}
              {% set total = item.total %}
              {% set cash_amount = item.cash_amount %}
              {% set credit_amount = item.credit_amount %}
            {% elif item.account_type == 'Cash' %}
              {% set total = item.total %}
              {% set cash_amount = item.total %}
            {% elif item.account_type == 'Credit Card' %}
              {% set total = item.total %}
              {% set credit_amount = item.total %}
            {% endif %}
            
            {% set cash_percentage = (cash_amount / total * 100) if total > 0 else 0 %}
            
            <tr class="bg-white border-b hover:bg-gray-50 {% if item.is_total %}bg-gray-100 font-semibold{% endif %}">
              <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">{{ item.month }}</td>
              <td class="px-6 py-4 {% if item.is_total %}font-bold{% endif %}">{{ item.user_name }}</td>
              <td class="px-6 py-4">{{ "%.2f"|format(cash_amount) }} ₪</td>
              <td class="px-6 py-4">{{ "%.2f"|format(credit_amount) }} ₪</td>
              <td class="px-6 py-4 font-semibold">{{ "%.2f"|format(total) }} ₪</td>
              <td class="px-6 py-4">{{ "%.1f"|format(cash_percentage) }}%</td>
            </tr>
          {% else %}
            <tr class="bg-white border-b">
              <td colspan="6" class="px-6 py-4 text-center text-gray-500">אין נתונים זמינים</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>

<!-- נתוני JSON (כמו שיש לך כבר) -->
<script id="monthly-data" type="application/json">
  {{ (monthly_expenses | default([])) | tojson }}
</script>
<script id="top-expenses-data" type="application/json">
  {{ (top_expenses | default([])) | tojson }}
</script>
<script id="category-data" type="application/json">
  {{ (category_expenses | default([])) | tojson }}
</script>
<script id="category-totals" type="application/json">
  {{ (category_expenses | default([])) | tojson }}
</script>
<script id="user-data" type="application/json">
  {{ (user_expenses | default([])) | tojson }}
</script>
<script id="recurring-user-data" type="application/json">
  {{ (recurring_user_expenses | default([])) | tojson }}
</script>
<script id="recurrences-data" type="application/json">
  {{ (recurring_monthly | default([])) | tojson }}
</script>
<script id="cash-vs-credit-data" type="application/json">
  {{ (cash_vs_credit | default([])) | tojson }}
</script>

<!-- Debug data for top expenses -->
<div id="debug-top-expenses" 
     data-top-expenses='{{ (top_expenses | default([])) | tojson }}'
     data-top-expenses-length="{{ (top_expenses | default([])) | length }}"
     style="display: none;">
</div>

<!-- Debug script for top expenses -->
<script>
console.log("=== FRONTEND DEBUG START ===");
const debugElement = document.getElementById('debug-top-expenses');
const topExpensesData = JSON.parse(debugElement.dataset.topExpenses);
const topExpensesLength = parseInt(debugElement.dataset.topExpensesLength);

console.log("Top expenses data from server:", topExpensesData);
console.log("Top expenses length:", topExpensesLength);
console.log("Top expenses is empty:", topExpensesLength === 0);

// Check if we're in the else block
if (topExpensesLength === 0) {
    console.log("WARNING: No top expenses found - will show 'אין הוצאות' message");
} else {
    console.log("Found", topExpensesLength, "top expenses");
    topExpensesData.forEach((expense, index) => {
        console.log(`Expense ${index + 1}:`, expense);
    });
}
console.log("=== FRONTEND DEBUG END ===");
</script>

<!-- ספריות -->
<script src="{{ url_for('static', path='js/vendor/chart.umd.min.js') }}"></script>
<script src="{{ url_for('static', path='js/vendor/htmx.min.js') }}"></script>

<!-- מודולים של הגרפים -->
<script type="module" src="{{ url_for('static', path='js/charts/helpers.js') }}"></script>
<script type="module" src="{{ url_for('static', path='js/charts/monthly.js') }}"></script>
<script type="module" src="{{ url_for('static', path='js/charts/donut.js') }}"></script>
<script type="module" src="{{ url_for('static', path='js/charts/recurrences.js') }}"></script>

{% endblock %}
