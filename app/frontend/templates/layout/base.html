<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}המנביטים{% endblock %}</title>
    
    <!-- Tailwind CSS - PERFORMANCE OPTIMIZED -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- HTMX - PERFORMANCE OPTIMIZED -->
    <script src="/static/js/vendor/htmx.min.js" defer></script>
    
    <!-- Custom CSS - PERFORMANCE OPTIMIZED -->
    <link rel="stylesheet" href="/static/css/main.css">
    
    <!-- Font Awesome - PERFORMANCE OPTIMIZED -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>
    
    <!-- Custom CSS -->
    <style>
        /* ===== Z-INDEX ARCHITECTURE ===== */
        /* 
        Z-Index Hierarchy (from lowest to highest):
        1. Background elements: 0-10
        2. Main content: 10-50
        3. Sidebar: 100-150
        4. Navigation: 200-250
        5. Modals/Overlays: 300-400
        6. Tooltips/Notifications: 500-600
        7. Floating elements: 700-800
        8. Loading/Spinners: 900-1000
        */
        
        [dir="rtl"] {
            direction: rtl;
        }
        
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        
        /* ===== NAVIGATION LAYER (z-index: 200-250) ===== */
        .nav-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 200;
            overflow: hidden;
        }
        
        .nav-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.1) 50%, transparent 70%);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .nav-link {
            position: relative;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin: 0 4px;
        }
        
        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            transform: scale(0);
            transition: transform 0.3s ease;
        }
        
        .nav-link:hover::before {
            transform: scale(1);
        }
        
        .nav-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* ===== FLOATING ACTION BUTTON (z-index: 700-800) ===== */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .fab:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
        }
        
        /* ===== SIDEBAR LAYER (z-index: 100-150) ===== */
        .sidebar {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            height: 100%;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            border-right: 1px solid #e5e7eb;
            overflow: hidden;
            max-width: 100%;
            box-sizing: border-box;
            z-index: 100;
            position: fixed;
            top: 64px; /* Space for navbar */
            right: 0;
        }
        
        /* Ensure sidebar is visible */
        #sidebar, #sidebar-collapsed {
            min-height: 100vh;
            position: fixed;
            top: 0;
            right: 0;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        /* Default state - show regular sidebar, hide collapsed */
        #sidebar {
            display: block !important;
            visibility: visible !important;
        }
        
        #sidebar-collapsed {
            display: none !important;
            visibility: hidden !important;
        }
        
        /* When collapsed state is active */
        body.sidebar-collapsed #sidebar {
            display: none !important;
            visibility: hidden !important;
        }
        
        body.sidebar-collapsed #sidebar-collapsed {
            display: block !important;
            visibility: visible !important;
        }
        
        /* ===== MAIN CONTENT LAYER (z-index: 10-50) ===== */
        .main-content {
            flex: 1;
            min-height: 100vh;
            background: white;
            border-radius: 8px;
            margin: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-right: 272px;
            margin-left: 16px;
            margin-top: 80px; /* Space for fixed navbar */
            z-index: 10;
            position: relative;
        }
        
        /* Fix sidebar width and positioning */
        #sidebar {
            width: 256px !important;
            max-width: 256px !important;
            flex-shrink: 0;
            min-width: 256px;
        }
        
        #sidebar-collapsed {
            width: 64px !important;
            max-width: 64px !important;
            flex-shrink: 0;
            min-width: 64px;
        }
        
        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            /* Mobile: Hide sidebar by default */
            .sidebar {
                transform: translateX(100%);
            }
            
            /* Mobile: Full width content */
            .main-content {
                margin-right: 16px;
                margin-left: 16px;
            }
            
            /* Mobile: Adjust navbar */
            .nav-gradient {
                padding: 0.5rem 1rem;
            }
            
            /* Mobile: Smaller FAB */
            .fab {
                width: 50px;
                height: 50px;
                bottom: 20px;
                right: 20px;
            }
        }
        
        @media (max-width: 1024px) {
            /* Tablet: Adjust sidebar width */
            #sidebar {
                width: 200px !important;
                max-width: 200px !important;
                min-width: 200px;
            }
            
            /* Tablet: Adjust main content margin */
            .main-content {
                margin-right: 216px;
            }
            
            body.sidebar-collapsed .main-content {
                margin-right: 80px;
            }
        }
        
        /* Sidebar item improvements */
        .sidebar-item {
            position: relative;
            overflow: hidden;
            border-radius: 12px;
            margin: 8px 0;
            transition: all 0.3s ease;
            text-decoration: none;
            display: block;
            color: white;
            padding: 12px 16px;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .sidebar-item:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white !important;
            transform: translateX(5px);
            text-decoration: none;
            margin-right: 8px;
        }
        
        .sidebar-item:hover i {
            color: white !important;
        }
        
        .sidebar-item.active {
            background: rgba(255, 255, 255, 0.3);
            color: white !important;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
            text-decoration: none;
            margin-right: 8px;
        }
        
        .sidebar-item.active i {
            color: white !important;
        }
        
        /* Sidebar toggle button */
        #sidebar-toggle, #sidebar-expand {
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            background: none;
            border: none;
            outline: none;
        }
        
        #sidebar-toggle:hover, #sidebar-expand:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.1);
        }
        
        .sidebar-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .sidebar-item:hover::before {
            left: 100%;
        }
        
        /* ===== MODAL/OVERLAY LAYER (z-index: 300-400) ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 300;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        /* Show modal when active */
        .modal-overlay.active {
            display: flex;
        }
        /* Ensure modal becomes visible when activated */
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 350;
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
        }
        
        /* ===== TOAST/NOTIFICATION LAYER (z-index: 500-600) ===== */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 16px 20px;
            z-index: 500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        /* ===== LOADING/SPINNER LAYER (z-index: 900-1000) ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 900;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Content Area */
        .main-content {
            background: white;
            min-height: 100vh;
            position: relative;
        }
        
        /* Footer Improvements */
        .footer {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            position: relative;
            overflow: hidden;
        }
        
        .footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.05) 50%, transparent 70%);
            animation: shimmer 4s infinite;
        }
        
        /* Loading Animation */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .fab {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .nav-link {
                margin: 2px;
                padding: 8px 12px;
            }
        }
    </style>
    
    {% block head %}{% endblock %}
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Main Navigation Bar -->
    <nav class="nav-gradient text-white shadow-lg relative z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo/Brand -->
                <div class="flex items-center animate-sequence">
                    <div class="w-8 h-8 bg-white rounded-lg mr-3 flex items-center justify-center">
                        <i class="fas fa-seedling text-purple-600"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gradient">המנביטים</h1>
                </div>
                
                <!-- Main Categories Navigation -->
                <div class="hidden md:flex space-x-8 space-x-reverse">
                    <a href="/finances/transactions" class="nav-link px-3 py-2 rounded-md text-sm font-medium hover:bg-purple-700 transition-colors animate-sequence">
                        <i class="fas fa-wallet mr-2"></i>
                        פיננסים
                    </a>
                </div>
                
                <!-- Mobile menu button -->
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-white hover:text-gray-300 focus:outline-none transition-colors">
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-purple-700 animate-slide-in-right">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="/finances/transactions" class="block px-3 py-2 rounded-md text-base font-medium hover:bg-purple-600 transition-colors">
                    <i class="fas fa-wallet mr-2"></i>
                    פיננסים
                </a>
            </div>
        </div>
    </nav>

            <!-- Main Content Area -->
        <div class="flex min-h-screen bg-gray-100 p-4 overflow-hidden">
        <!-- Sidebar (only for specific sections like finances) -->
        {% if show_sidebar %}
        <div id="sidebar" class="sidebar shadow-lg sidebar-transition">
            <div class="p-6">
                <!-- Sidebar Header with Toggle Button -->
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-gray-800 animate-sequence">
                        <i class="fas fa-wallet mr-2"></i>
                        פיננסים
                    </h2>
                    <button id="sidebar-toggle" class="text-gray-500 hover:text-gray-700 transition-colors" title="סגור/פתח סיידבר">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                
                <!-- Finance Navigation -->
                <nav class="space-y-2">
                    <a href="/finances/transactions" class="sidebar-item flex items-center px-3 py-2 transition-all duration-200 {% if 'transactions' in request.path %}active{% endif %}">
                        <i class="fas fa-exchange-alt mr-3 w-5 text-center"></i>
                        <span>עסקאות</span>
                    </a>
                </nav>
                

            </div>
        </div>
        
        <!-- Collapsed Sidebar (when toggled) -->
        <div id="sidebar-collapsed" class="sidebar shadow-lg sidebar-transition hidden">
            <div class="p-4">
                <div class="flex justify-center mb-4">
                    <button id="sidebar-expand" class="text-gray-500 hover:text-gray-700 transition-colors" title="פתח סיידבר">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                
                <nav class="space-y-2">
                    <a href="/finances/transactions" class="sidebar-item flex items-center justify-center px-2 py-3 transition-all duration-200 {% if 'transactions' in request.path %}active{% endif %}" title="עסקאות">
                        <i class="fas fa-exchange-alt"></i>
                    </a>
                </nav>
            </div>
        </div>
        {% endif %}
        
        <!-- Main Content -->
        <div class="flex-1 main-content">
            <main class="p-6 relative z-10">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab" onclick="showQuickActions()" title="פעולות מהירות">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Footer -->
    <footer class="footer text-white py-8 mt-auto relative">
        <div class="max-w-7xl mx-auto px-4 text-center relative z-10">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-6">
                <div class="animate-sequence">
                    <h3 class="text-lg font-semibold mb-3">המנביטים</h3>
                    <p class="text-gray-300">פלטפורמה מתקדמת לניהול חיים מאוזנים ומאושרים</p>
                </div>
                <div class="animate-sequence">
                    <h3 class="text-lg font-semibold mb-3">קישורים מהירים</h3>
                    <div class="space-y-2">
                        <a href="/finances/transactions" class="block text-gray-300 hover:text-white transition-colors">פיננסים</a>
                    </div>
                </div>
                <div class="animate-sequence">
                    <h3 class="text-lg font-semibold mb-3">צור קשר</h3>
                    <div class="space-y-2">
                        <p class="text-gray-300">support@hamanbitim.co.il</p>
                        <div class="flex justify-center space-x-4 space-x-reverse">
                            <a href="#" class="text-gray-300 hover:text-white transition-colors">
                                <i class="fab fa-facebook text-xl"></i>
                            </a>
                            <a href="#" class="text-gray-300 hover:text-white transition-colors">
                                <i class="fab fa-twitter text-xl"></i>
                            </a>
                            <a href="#" class="text-gray-300 hover:text-white transition-colors">
                                <i class="fab fa-instagram text-xl"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-600 pt-6">
                <p>&copy; 2024 המנביטים. כל הזכויות שמורות.</p>
            </div>
        </div>
    </footer>

    <!-- Quick Actions Modal -->
    <div id="quickActionsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="card-header">
                <h3 class="text-lg font-semibold text-gray-900">פעולות מהירות</h3>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="quickAction('add-transaction')" class="btn btn-primary w-full">
                        <i class="fas fa-plus mr-2"></i>
                        הוסף עסקה
                    </button>
                    <button onclick="quickAction('add-goal')" class="btn btn-success w-full">
                        <i class="fas fa-bullseye mr-2"></i>
                        הוסף מטרה
                    </button>
                    <button onclick="quickAction('add-memory')" class="btn btn-secondary w-full">
                        <i class="fas fa-heart mr-2"></i>
                        הוסף זיכרון
                    </button>
                    <button onclick="quickAction('view-stats')" class="btn btn-warning w-full">
                        <i class="fas fa-chart-bar mr-2"></i>
                        צפה בסטטיסטיקות
                    </button>
                </div>
            </div>
            <div class="card-footer">
                <button onclick="hideModal('quickActionsModal')" class="btn btn-outline w-full">
                    סגור
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <!-- PERFORMANCE OPTIMIZED SCRIPTS -->
    <script src="/static/js/core/animations.js" defer></script>
    <script>
        // PERFORMANCE OPTIMIZED JAVASCRIPT
        
        // Debounce utility for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Throttle utility for performance
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }
        
        // Mobile menu toggle - PERFORMANCE OPTIMIZED
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        if (mobileMenuButton) {
            mobileMenuButton.addEventListener('click', function() {
                const mobileMenu = document.getElementById('mobile-menu');
                if (mobileMenu) {
                    mobileMenu.classList.toggle('hidden');
                }
            });
        }
        
        // Toggle sidebar function
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarCollapsed = document.getElementById('sidebar-collapsed');
            const isCollapsed = sidebar.classList.contains('hidden');
            
            if (isCollapsed) {
                // Expand sidebar
                sidebar.classList.remove('hidden');
                sidebarCollapsed.classList.add('hidden');
                document.body.classList.remove('sidebar-collapsed');
                localStorage.setItem('sidebarCollapsed', 'false');
            } else {
                // Collapse sidebar
                sidebar.classList.add('hidden');
                sidebarCollapsed.classList.remove('hidden');
                document.body.classList.add('sidebar-collapsed');
                localStorage.setItem('sidebarCollapsed', 'true');
            }
        }

        // Initialize sidebar state on page load - PERFORMANCE OPTIMIZED
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const sidebarCollapsed = document.getElementById('sidebar-collapsed');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarExpand = document.getElementById('sidebar-expand');

            if (sidebar && sidebarCollapsed) {
                // Check localStorage for saved state
                const isCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';

                if (isCollapsed) {
                    sidebar.classList.add('hidden');
                    sidebarCollapsed.classList.remove('hidden');
                    document.body.classList.add('sidebar-collapsed');
                } else {
                    sidebar.classList.remove('hidden');
                    sidebarCollapsed.classList.add('hidden');
                    document.body.classList.remove('sidebar-collapsed');
                }

                // Add event listeners with performance optimizations
                if (sidebarToggle) {
                    sidebarToggle.addEventListener('click', toggleSidebar);
                }

                if (sidebarExpand) {
                    sidebarExpand.addEventListener('click', toggleSidebar);
                }

                // Debug: Log sidebar state
                console.log('Sidebar initialized:', {
                    sidebar: sidebar ? 'found' : 'not found',
                    sidebarCollapsed: sidebarCollapsed ? 'found' : 'not found',
                    sidebarToggle: sidebarToggle ? 'found' : 'not found',
                    sidebarExpand: sidebarExpand ? 'found' : 'not found',
                    isCollapsed: isCollapsed
                });
            } else {
                console.log('Sidebar elements not found');
            }
        });
        
        // Quick actions - PERFORMANCE OPTIMIZED
        function showQuickActions() {
            if (typeof showModal === 'function') {
                showModal('quickActionsModal');
            }
        }
        
        function quickAction(action) {
            if (typeof hideModal === 'function') {
                hideModal('quickActionsModal');
            }
            
            switch(action) {
                case 'add-transaction':
                    window.location.href = '/finances/transactions';
                    break;
                case 'add-goal':
                    window.location.href = '/goals';
                    break;
                case 'add-memory':
                    window.location.href = '/memories';
                    break;
                case 'view-stats':
                    window.location.href = '/finances/statistics';
                    break;
            }
        }
        
        // PERFORMANCE OPTIMIZATIONS
        // Preload critical resources
        function preloadCriticalResources() {
            // Preload critical CSS
            const criticalCSS = document.createElement('link');
            criticalCSS.rel = 'preload';
            criticalCSS.as = 'style';
            criticalCSS.href = '/static/css/main.css';
            document.head.appendChild(criticalCSS);
        }
        
        // Lazy load non-critical resources
        function lazyLoadResources() {
            // Lazy load images
            const images = document.querySelectorAll('img[data-src]');
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.remove('lazy-load');
                        img.classList.add('loaded');
                        observer.unobserve(img);
                    }
                });
            });
            
            images.forEach(img => imageObserver.observe(img));
        }
        
        // Initialize performance optimizations and animations
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                preloadCriticalResources();
                lazyLoadResources();
                // Start page animations immediately
                document.body.classList.add('loaded');
            });
        } else {
            preloadCriticalResources();
            lazyLoadResources();
            // Start page animations immediately
            document.body.classList.add('loaded');
        }
        
        // Service Worker registration for caching (if supported)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('SW registered: ', registration);
                    })
                    .catch(function(registrationError) {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
