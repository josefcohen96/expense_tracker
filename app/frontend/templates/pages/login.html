{% extends "layout/base.html" %}
{% block title %}התחברות{% endblock %}

{% block content %}
<div class="max-w-md mx-auto mt-10">
  <div class="card">
    <div class="card-header">
      <h2 class="text-xl font-semibold text-gray-900 flex items-center">
        <i class="fas fa-lock mr-3 text-orange-600"></i>
        התחברות
      </h2>
    </div>
    <form id="loginForm" method="post" action="/login">
      <div class="card-body space-y-4">
        {% if error %}
          <div class="p-3 rounded bg-red-100 text-red-800 text-sm">{{ error }}</div>
        {% endif %}
        <div class="form-group">
          <label for="username" class="form-label">שם משתמש</label>
          <input type="text" id="username" name="username" required class="form-input" autocomplete="username">
        </div>
        <div class="form-group">
          <label for="password" class="form-label">סיסמה</label>
          <input type="password" id="password" name="password" required class="form-input" autocomplete="current-password">
        </div>
        
      </div>
      <div class="card-footer flex justify-end">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-sign-in-alt mr-2"></i>
          התחבר
        </button>
      </div>
    </form>
  </div>
  <p class="text-center text-xs text-gray-500 mt-4">כניסה מותרת רק למשתמש מורשה</p>
  <script>
    try {
      console.log('[LOGIN] page loaded', {
        location: window.location.href,
        next: new URLSearchParams(window.location.search).get('next') || null,
        sw: !!navigator.serviceWorker,
        swController: !!navigator.serviceWorker?.controller,
        cookies: document.cookie,
        timestamp: new Date().toISOString()
      });
      
      const f = document.getElementById('loginForm');
      f?.addEventListener('submit', function (e) {
        const u = (document.getElementById('username') || {}).value;
        const p = (document.getElementById('password') || {}).value;
        
        console.log('[LOGIN] form submission started', { 
          username: u,
          passwordLength: p.length,
          timestamp: new Date().toISOString(),
          cookies: document.cookie,
          formAction: f.action,
          formMethod: f.method
        });
        
        // Notify service worker about login attempt
        if (navigator.serviceWorker && navigator.serviceWorker.controller) {
          console.log('[LOGIN] notifying service worker about login attempt');
          navigator.serviceWorker.controller.postMessage({
            type: 'LOGIN_ATTEMPT',
            username: u,
            timestamp: Date.now()
          });
        } else {
          console.log('[LOGIN] no service worker controller available');
        }
        
        // Let the normal form submit happen; we only trace
        console.log('[LOGIN] allowing form submission to proceed');
      });
      
      // Monitor page visibility changes
      document.addEventListener('visibilitychange', function() {
        console.log('[LOGIN] page visibility changed', {
          hidden: document.hidden,
          visibilityState: document.visibilityState,
          timestamp: new Date().toISOString()
        });
      });
      
      // Monitor beforeunload
      window.addEventListener('beforeunload', function() {
        console.log('[LOGIN] page unloading', {
          timestamp: new Date().toISOString(),
          cookies: document.cookie
        });
      });
      
      document.getElementById('username').focus();
    } catch (err) {
      console.error('[LOGIN] init error', err);
    }
  </script>
{% endblock %}


