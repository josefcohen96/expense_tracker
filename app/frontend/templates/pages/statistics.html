{% extends "layout/base.html" %}
{% block title %}סטטיסטיקות{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-6">סטטיסטיקות</h1>

<div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
  <!-- חודשי -->
  <section class="bg-white rounded-2xl shadow p-5 xl:col-span-2">
    <header class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">הוצאות 6 חודשים אחרונים</h2>
      <!-- קטגוריה סינון -->
      <div>
        <label for="monthly-category" class="mr-2">קטגוריה:</label>
        <select id="monthly-category" class="border rounded px-2 py-1">
          <option value="total">סה"כ</option>
          {% for cat in category_expenses %}
            <option value="{{ cat.category }}">{{ cat.category }}</option>
          {% endfor %}
        </select>
      </div>
    </header>
    <!-- שמים קונטיינר עם גובה קבוע וה-canvas מתרחב בתוכו -->
    <div class="relative h-72 md:h-80 xl:h-96">
      <canvas id="monthly-chart" class="absolute inset-0"></canvas>
    </div>
  </section>

  <!-- 5 ההוצאות הכי גדולות -->
  <section class="bg-white rounded-2xl shadow p-5">
    <header class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">5 ההוצאות הכי גדולות (3 חודשים אחרונים)</h2>
    </header>
    <div class="space-y-3">
      {% for expense in top_expenses %}
      <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
        <div class="flex-1">
          <div class="flex items-center gap-2">
            <span class="font-medium text-gray-900">{{ expense.notes or "ללא הערות" }}</span>
            <span class="text-sm text-gray-500">({{ expense.category }})</span>
          </div>
          <div class="text-sm text-gray-600">
            {{ expense.date }} • {{ expense.user_name }}
            {% if expense.account_name %}
            • {{ expense.account_name }}
            {% endif %}
          </div>
        </div>
        <div class="text-right">
          <div class="text-lg font-bold text-red-600">
            {{ "%.2f"|format(expense.amount|abs) }} ₪
          </div>
        </div>
      </div>
      {% else %}
      <div class="text-center text-gray-500 py-8">
        אין הוצאות ב-3 חודשים האחרונים
      </div>
      {% endfor %}
    </div>
  </section>

  <!-- לפי קטגוריה -->
  <section class="bg-white rounded-2xl shadow p-5 xl:col-span-2">
    <header class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">חלוקה לפי קטגוריה</h2>
      <!-- Month selector -->
      <div class="flex items-center gap-2">
        <label for="donut-month-single">בחר חודש:</label>
        <input id="donut-month-single" type="month" class="border rounded px-2 py-1" />
      </div>
    </header>
    <div class="relative h-72 md:h-80 xl:h-96">
      <canvas id="donut-chart" class="absolute inset-0"></canvas>
    </div>
  </section>

  <!-- הוצאות קבועות -->
  <section class="bg-white rounded-2xl shadow p-5">
    <header class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">הוצאות קבועות 6 חודשים אחרונים</h2>
    </header>
    <div class="relative h-72 md:h-80 xl:h-96">
      <canvas id="recurrences-chart" class="absolute inset-0"></canvas>
    </div>
  </section>
  
  <!-- מזומן מול אשראי -->
  <section class="bg-white rounded-2xl shadow p-5 xl:col-span-3">
    <header class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">מזומן מול אשראי - 6 חודשים אחרונים</h2>
    </header>
    <div class="overflow-x-auto">
      <table class="w-full text-sm text-left text-gray-500">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
          <tr>
            <th scope="col" class="px-6 py-3">חודש</th>
            <th scope="col" class="px-6 py-3">מזומן</th>
            <th scope="col" class="px-6 py-3">כרטיס אשראי</th>
            <th scope="col" class="px-6 py-3">סה"כ</th>
            <th scope="col" class="px-6 py-3">אחוז מזומן</th>
          </tr>
        </thead>
        <tbody>
          {% set cash_vs_credit_dict = {} %}
          {% for item in cash_vs_credit %}
            {% if item.month not in cash_vs_credit_dict %}
              {% set _ = cash_vs_credit_dict.update({item.month: {'Cash': 0, 'Credit Card': 0}}) %}
            {% endif %}
            {% if item.account_type == 'Cash' %}
              {% set _ = cash_vs_credit_dict[item.month].update({'Cash': item.total}) %}
            {% elif item.account_type == 'Credit Card' %}
              {% set _ = cash_vs_credit_dict[item.month].update({'Credit Card': item.total}) %}
            {% endif %}
          {% endfor %}
          
          {% for month, data in cash_vs_credit_dict.items() %}
            {% set total = data['Cash'] + data['Credit Card'] %}
            {% set cash_percentage = (data['Cash'] / total * 100) if total > 0 else 0 %}
            <tr class="bg-white border-b hover:bg-gray-50">
              <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">{{ month }}</td>
              <td class="px-6 py-4">{{ "%.2f"|format(data['Cash']) }} ₪</td>
              <td class="px-6 py-4">{{ "%.2f"|format(data['Credit Card']) }} ₪</td>
              <td class="px-6 py-4 font-semibold">{{ "%.2f"|format(total) }} ₪</td>
              <td class="px-6 py-4">{{ "%.1f"|format(cash_percentage) }}%</td>
            </tr>
          {% else %}
            <tr class="bg-white border-b">
              <td colspan="5" class="px-6 py-4 text-center text-gray-500">אין נתונים זמינים</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>

<!-- נתוני JSON (כמו שיש לך כבר) -->
<script id="monthly-data" type="application/json">
  {{ (monthly_expenses | default([])) | tojson }}
</script>
<script id="top-expenses-data" type="application/json">
  {{ (top_expenses | default([])) | tojson }}
</script>
<script id="category-data" type="application/json">
  {{ (category_expenses | default([])) | tojson }}
</script>
<script id="category-totals" type="application/json">
  {{ (category_expenses | default([])) | tojson }}
</script>
<script id="user-data" type="application/json">
  {{ (user_expenses | default([])) | tojson }}
</script>
<script id="recurring-user-data" type="application/json">
  {{ (recurring_user_expenses | default([])) | tojson }}
</script>
<script id="recurrences-data" type="application/json">
  {{ (recurring_monthly | default([])) | tojson }}
</script>
<script id="cash-vs-credit-data" type="application/json">
  {{ (cash_vs_credit | default([])) | tojson }}
</script>



<!-- Debug data for top expenses -->
<div id="debug-top-expenses" 
     data-top-expenses='{{ (top_expenses | default([])) | tojson }}'
     data-top-expenses-length="{{ (top_expenses | default([])) | length }}"
     style="display: none;">
</div>

<!-- Debug script for top expenses -->
<script>
console.log("=== FRONTEND DEBUG START ===");
const debugElement = document.getElementById('debug-top-expenses');
const topExpensesData = JSON.parse(debugElement.dataset.topExpenses);
const topExpensesLength = parseInt(debugElement.dataset.topExpensesLength);

console.log("Top expenses data from server:", topExpensesData);
console.log("Top expenses length:", topExpensesLength);
console.log("Top expenses is empty:", topExpensesLength === 0);

// Check if we're in the else block
if (topExpensesLength === 0) {
    console.log("WARNING: No top expenses found - will show 'אין הוצאות' message");
} else {
    console.log("Found", topExpensesLength, "top expenses");
    topExpensesData.forEach((expense, index) => {
        console.log(`Expense ${index + 1}:`, expense);
    });
}
console.log("=== FRONTEND DEBUG END ===");
</script>

<!-- ספריות -->
<script src="{{ url_for('static', path='js/vendor/chart.umd.min.js') }}"></script>
<script src="{{ url_for('static', path='js/vendor/htmx.min.js') }}"></script>

<!-- מודולים של הגרפים -->
<script type="module" src="{{ url_for('static', path='js/charts/helpers.js') }}"></script>
<script type="module" src="{{ url_for('static', path='js/charts/monthly.js') }}"></script>
<script type="module" src="{{ url_for('static', path='js/charts/donut.js') }}"></script>
<script type="module" src="{{ url_for('static', path='js/charts/recurrences.js') }}"></script>

{% endblock %}
