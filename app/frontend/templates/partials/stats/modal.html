<!-- Drilldown Modal -->
<div id="drilldown-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden"
    aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] flex flex-col mx-4">
        <!-- Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b">
            <h3 class="text-lg font-semibold text-gray-900" id="modal-title">
                פירוט עסקאות
            </h3>
            <button type="button" class="text-gray-400 hover:text-gray-500 focus:outline-none"
                onclick="closeDrilldownModal()">
                <span class="sr-only">סגור</span>
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Content -->
        <div id="drilldown-modal-content" class="flex-1 overflow-y-auto p-6">
            <div class="flex justify-center py-8">
                <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
            </div>
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 px-6 py-3 flex justify-end rounded-b-lg">
            <button type="button"
                class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none"
                onclick="closeDrilldownModal()">
                סגור
            </button>
        </div>
    </div>
</div>

<script>
    function closeDrilldownModal() {
        document.getElementById('drilldown-modal').classList.add('hidden');
    }

    async function openDrilldownModal(params) {
        const modal = document.getElementById('drilldown-modal');
        const content = document.getElementById('drilldown-modal-content');
        const title = document.getElementById('modal-title');

        modal.classList.remove('hidden');

        // Reset to loading state
        content.innerHTML = `
      <div class="flex justify-center py-8">
        <svg class="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </div>
    `;

        // Build URL
        const url = new URL('/finances/statistics/drilldown', window.location.origin);
        url.searchParams.set('partial', 'true');
        if (params.month) url.searchParams.set('month', params.month);
        if (params.metric) url.searchParams.set('metric', params.metric);
        if (params.category) url.searchParams.set('category', params.category);

        try {
            const resp = await fetch(url.toString());
            if (!resp.ok) throw new Error('Network response was not ok');
            const html = await resp.text();
            content.innerHTML = html;

            // Update title based on params
            let titleText = 'פירוט עסקאות';
            if (params.month) titleText += ` - ${params.month}`;
            if (params.metric === 'income') titleText = 'פירוט הכנסות';
            if (params.metric === 'expenses') titleText = 'פירוט הוצאות';
            if (params.category) titleText = `פירוט הוצאות - ${params.category}`;

            title.innerText = titleText;

        } catch (e) {
            console.error(e);
            content.innerHTML = `<div class="text-red-600 text-center py-4">אירעה שגיאה בטעינת הנתונים</div>`;
        }
    }
</script>